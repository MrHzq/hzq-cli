const path = require("path");
const log = require("../../utils/log");
const Spinner = require("../../utils/spinner");
const runStep = require("../../utils/runStep");
{{#if needConfig}}
const { getDirName } = require("../../utils/path");
const { readConfig, writeConfig } = require("../../config/handler");
{{/if}}
{{#if needInquirer}}
const { prompt, notNumberRule } = require("../../utils/inquirer");
{{/if}}
const CmdList = require("../../bin/handleCmdList");
const { getDirRePath } = require("../../utils/path");
const { getFilterList, formatCmdList } = require("../../utils/common");

let mainSpinner;

{{#if needConfig}}
let config;
const configKey = getDirName(__dirname);

// 获取当前所需配置
const getConfig = () => {
  const allConfig = readConfig() || {};
  config = allConfig[configKey] || {};
};

// 设置当前所得配置
const setConfig = () => {
  const allConfig = readConfig() || {};
  writeConfig({ ...allConfig, [configKey]: config });
};
{{/if}}

{{#if needInquirer}}
let cmd, filePath;

// 初始化变量
const initVar = (answers) => {
  cmd = answers.cmd;
  filePath = getDirRePath(__dirname, cmd);
};
{{else}}
// 初始化变量
const initVar = (answers) => {};
{{/if}}

const runCmd = () => {
  const { fun } = require(filePath);

  if (typeof fun === "function") fun();
  else log.error(`未找到对应命令 ${cmd}`);
};

// 主流程 - step 集合
const mainStepList = [
  {
    fun: runCmd,
    desc: () => "运行命令",
  },
];

// todo 流程 - step 集合
const todoStepList = [
{{#if needTodo}}
  {
    desc: () => "todo...",
  },
{{else}}
  // {
  //   desc: () => "todo...",
  // },
{{/if}}
];

const getCmdList = (selfCmd, filterCmd) => {
  const curCmd = CmdList.find(selfCmd);
  return formatCmdList(
    getFilterList(curCmd.children, { cmd: filterCmd }, "eq")
  );
};

module.exports = async (_, options = {}) => {
  const { _name, _description, args } = options;

  const [arg] = args || [];

  {{#if needConfig}}
  getConfig();
  {{/if}}

  const choices = getCmdList(_name, arg);

  if (choices.length === 0) return log.warn("未找到相关命令");

  let answers = {};

  if (choices.length === 1) {
    answers = { cmd: choices[0].value };
  } else {
  {{#if needInquirer}}
    answers = await prompt([
      {
        type: "list",
        name: "cmd",
        message: "请选择要运行的命令:",
        choices,
      },
    ]);
  {{/if}}
  }

  {{#if needConfig}}
  Object.assign(config, answers);
  setConfig();
  {{/if}}

  initVar(answers);

  mainSpinner = new Spinner(_description);

  if (mainStepList.length === 1 && !todoStepList?.length) {
    await mainStepList[0].fun();
    return mainSpinner.succeed();
  }

  mainSpinner.start();

  const runSuccess = await runStep(mainStepList);

  if (runSuccess) {
    mainSpinner.succeed();

  {{#if needTodo}}
    log.warn("next todo", true);
    runStep(todoStepList, "warn", { prefix: "todo" });
  {{/if}}
  } else {
    mainSpinner.fail();
  }
};
